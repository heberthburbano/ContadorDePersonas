<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Flow</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-family: 'Poppins', sans-serif;
            --transition-speed: 0.3s;
            --font-size-base: 16px;
        }

        html.font-size-small { --font-size-base: 14px; }
        html.font-size-large { --font-size-base: 18px; }


        [data-theme="light"] {
            --bg-color: #e0e5ec;
            --text-primary: #5f677A;
            --text-secondary: #a3b1c6;
            --primary-color: #007BFF;
            --shadow-light: #ffffff;
            --shadow-dark: #a3b1c6;
            --card-gradient: linear-gradient(145deg, #f0f5fd, #c8cdd3);
        }

        [data-theme="dark"] {
            --bg-color: #2c3038;
            --text-primary: #f8fafc; /* Brighter white */
            --text-secondary: #cbd5e1; /* Lighter grey for high contrast */
            --primary-color: #4facfe;
            --shadow-light: #3a4049; /* Adjusted for more depth */
            --shadow-dark: #1e2126; /* Adjusted for more depth */
            --card-gradient: linear-gradient(145deg, #2f333b, #272a31);
        }
        
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: var(--font-size-base);
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem 1rem;
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        .app-container {
            width: 100%;
            max-width: 480px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        @media (min-width: 992px) {
            .app-container {
                max-width: 1200px;
                grid-template-columns: minmax(auto, 480px) 1fr;
                align-items: flex-start;
            }
        }
        
        .main-content, .side-content {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }


        /* Soft UI / Neumorphism Style */
        .neumorphic {
            background: var(--card-gradient);
            border-radius: 20px;
            box-shadow: 8px 8px 16px var(--shadow-dark), -8px -8px 16px var(--shadow-light);
            transition: box-shadow var(--transition-speed);
        }

        .neumorphic-inset {
            border-radius: 12px;
            box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light);
        }

        .card {
            padding: 2rem;
            text-align: center;
            position: relative;
        }
        
        h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
            font-weight: 600;
        }
        
        p {
            font-size: 1rem;
            line-height: 1.6;
        }

        /* --- Timer Section --- */
        .timer-modes {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            padding: 0.5rem;
            margin-bottom: 2rem;
        }
        
        .mode-button {
            background: transparent;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-family: var(--font-family);
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-size: 1rem;
        }
        
        .mode-button.active {
            color: var(--primary-color);
            background-color: var(--bg-color);
            box-shadow: inset 3px 3px 7px var(--shadow-dark), inset -3px -3px 7px var(--shadow-light);
        }

        .timer-progress-circle {
            position: relative;
            width: 280px;
            height: 280px;
            margin: 0 auto 2rem;
        }

        .timer-progress-circle svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }
        
        .progress-ring__circle {
            transition: stroke-dashoffset 0.5s;
            stroke-linecap: round;
        }

        .timer-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .timer-edit-input {
            width: 2.5ch;
            background: transparent;
            border: none;
            border-bottom: 2px solid var(--text-secondary);
            color: var(--text-primary);
            font-family: var(--font-family);
            font-size: inherit;
            font-weight: inherit;
            text-align: center;
            -moz-appearance: textfield;
        }
        .timer-edit-input:focus {
            outline: none;
            border-bottom-color: var(--primary-color);
        }
        .timer-edit-input::-webkit-inner-spin-button, 
        .timer-edit-input::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        .current-task-display {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
            min-height: 1.5em;
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
        }

        .control-button {
            background: var(--card-gradient);
            border: none;
            width: 4rem;
            height: 4rem;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-primary);
        }
        .control-button:active {
            transform: scale(0.95);
            box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light);
        }

        .control-button .icon {
            width: 2rem;
            height: 2rem;
        }

        #start-stop-btn {
            width: 5rem;
            height: 5rem;
        }
        #start-stop-btn .icon {
            width: 2.5rem;
            height: 2.5rem;
        }
        
        /* --- Tareas y Controles --- */
        .collapsible-card summary {
            list-style: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
         .collapsible-card summary::after {
            content: 'â–¼';
            transition: transform var(--transition-speed);
        }
        .collapsible-card[open] summary::after {
            transform: rotate(180deg);
        }

        .collapsible-content {
            padding-top: 1.5rem;
        }
        
        #new-task-form { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
        #new-task-input {
            flex-grow: 1;
            padding: 1rem;
            border: none;
            color: var(--text-primary);
            font-size: 1rem;
        }
        #add-task-btn {
            padding: 0 1.5rem;
            font-weight: 700;
            font-size: 1.5rem;
            border-radius: 12px;
            border: none;
            color: var(--primary-color);
        }

        #task-list { list-style: none; text-align: left; }
        #task-list li {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: 8px;
            transition: background-color var(--transition-speed);
            font-size: 1rem;
        }
         #task-list li.active { background-color: rgba(0,0,0,0.1); }
        .task-name { flex-grow: 1; cursor: pointer; padding: 0 0.5rem;}
        .delete-task { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.5rem; }

        .control-group {
            text-align: left;
            margin-bottom: 1.5rem;
        }
        .control-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 1rem;
        }
        .control-group input, .control-group select, .control-group button {
            width: 100%;
            padding: 0.75rem;
            border: none;
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        [data-theme="dark"] .control-group input, 
        [data-theme="dark"] .control-group select {
            background-color: var(--bg-color); /* Make inputs stand out */
        }

        .control-group select option { background-color: var(--shadow-dark); }
        
        .time-input-group {
            display: flex;
            gap: 0.5rem;
        }
        .time-input-group input {
            width: 100%;
            text-align: center;
        }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }


        .btn-primary {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            color: white;
            background-color: var(--primary-color);
            cursor: pointer;
            font-weight: 600;
        }
        .custom-file-label {
            display: block;
            margin-top: 0.5rem;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
        }
        .custom-file-label:hover {
            opacity: 0.8;
        }

        /* --- Estilos para el interruptor de notificaciones --- */
        .switch {
          position: relative;
          display: inline-block;
          width: 60px;
          height: 34px;
        }
        .switch input { 
          opacity: 0;
          width: 0;
          height: 0;
        }
        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          transition: .4s;
          border-radius: 34px;
        }
        .slider:before {
          position: absolute;
          content: "";
          height: 26px;
          width: 26px;
          left: 4px;
          bottom: 4px;
          background-color: #fff; /* Knob color for light theme */
          transition: .4s;
          border-radius: 50%;
        }
        input:checked + .slider {
          background-color: var(--primary-color);
        }
        input:checked + .slider:before {
          transform: translateX(26px);
        }

        /* Specific styles for dark theme visibility */
        [data-theme="dark"] .slider:before {
            background-color: var(--text-secondary);
        }
        
        [data-theme="dark"] .control-group select option {
            background-color: var(--bg-color);
            color: var(--text-primary);
        }

        /* Placeholder text color for dark theme */
        [data-theme="dark"] #new-task-input::-webkit-input-placeholder { /* Chrome/Opera/Safari */
          color: var(--text-secondary);
          opacity: 0.7;
        }
        [data-theme="dark"] #new-task-input::-moz-placeholder { /* Firefox 19+ */
          color: var(--text-secondary);
          opacity: 0.7;
        }
        [data-theme="dark"] #new-task-input:-ms-input-placeholder { /* IE 10+ */
          color: var(--text-secondary);
          opacity: 0.7;
        }
        [data-theme="dark"] #new-task-input:-moz-placeholder { /* Firefox 18- */
          color: var(--text-secondary);
          opacity: 0.7;
        }

        /* --- Modals --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transform: scale(0.95);
            transition: all var(--transition-speed) ease;
            z-index: 1003; /* Increased z-index */
        }
        .modal.visible {
            opacity: 1;
            visibility: visible;
            transform: scale(1);
        }
        .modal-content {
            width: 90%;
            max-width: 640px;
        }
        .video-container {
            position: relative; padding-bottom: 56.25%; height: 0;
            overflow: hidden; max-width: 100%; border-radius: 12px; margin-top: 1rem;
        }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        #detail-task-list {
            list-style: none;
            text-align: left;
            margin-top: 1rem;
        }
        #detail-task-list li {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        #detail-task-list .icon {
            width: 1.2rem;
            height: 1.2rem;
        }

        /* --- Notepad Section --- */
        #notepad-toggle {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            width: 50px;
            height: 50px;
            padding: 8px;
            z-index: 1000;
        }
        #notepad-container {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            width: 90%;
            max-width: 480px;
            height: 70vh;
            text-align: left;
        }

        .notepad-header {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 0.5rem;
        }
        #close-notepad-btn {
            width: 40px;
            height: 40px;
            padding: 8px;
        }
        #notepad-textarea {
            flex-grow: 1;
            width: 100%;
            border: none;
            background: transparent;
            color: var(--text-primary);
            resize: none;
            font-family: var(--font-family);
            font-size: 1rem;
        }
        #notepad-textarea:focus {
            outline: none;
        }

        /* --- Sidebar --- */
        #sidebar-toggle {
            position: fixed;
            top: 1.5rem;
            left: 1.5rem;
            width: 50px;
            height: 50px;
            padding: 8px;
            z-index: 1000;
        }

        #sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-speed), visibility var(--transition-speed);
            z-index: 1001;
        }

        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            max-width: 400px;
            height: 100%;
            background-color: var(--bg-color);
            transform: translateX(-100%);
            transition: transform var(--transition-speed) ease;
            z-index: 1002;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        
        body.sidebar-open #sidebar {
            transform: translateX(0);
        }
        body.sidebar-open #sidebar-overlay {
            opacity: 1;
            visibility: visible;
        }

        /* --- Calendar --- */
        #calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        #calendar-month-year { font-weight: 600; font-size: 1.1rem; }
        #calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }
        .calendar-day-name { font-weight: 600; text-align: center; color: var(--text-secondary); font-size: 0.9em;}
        .calendar-day {
            display: flex;
            justify-content: center;
            align-items: center;
            aspect-ratio: 1 / 1;
            border-radius: 50%;
            cursor: pointer;
            position: relative;
            font-size: 0.9rem;
        }
        .calendar-day.has-data::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--primary-color);
        }
        .calendar-day.today {
            background-color: var(--primary-color);
            color: white;
        }
        #calendar-tooltip {
            position: absolute;
            background-color: var(--shadow-dark);
            color: var(--bg-color);
            padding: 0.5rem;
            border-radius: 8px;
            font-size: 0.9rem;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1003;
        }

    </style>
</head>
<body>
    <button id="sidebar-toggle" class="control-button neumorphic">
        <svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg>
    </button>
    <button id="notepad-toggle" class="control-button neumorphic">
        <svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M14 17.25V14.5a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-1.75v2.75a.75.75 0 0 1-1.5 0ZM9.5 10.75a.75.75 0 0 0 0 1.5h5a.75.75 0 0 0 0-1.5h-5Zm-3.25.75a.75.75 0 0 1 .75-.75h1.5a.75.75 0 0 1 0 1.5h-1.5a.75.75 0 0 1-.75-.75ZM20 3.75h-4.25V3a.75.75 0 0 0-.75-.75h-6A.75.75 0 0 0 8.25 3v.75H4A1.75 1.75 0 0 0 2.25 5.5v13A1.75 1.75 0 0 0 4 20.25h16A1.75 1.75 0 0 0 21.75 18.5v-13A1.75 1.75 0 0 0 20 3.75Zm.25 14.75a.25.25 0 0 1-.25.25H4a.25.25 0 0 1-.25-.25v-13a.25.25 0 0 1 .25-.25h4.25V6.5a.75.75 0 0 0 .75.75h6a.75.75 0 0 0 .75-.75V5.5H20a.25.25 0 0 1 .25.25v13Z"></path></svg>
    </button>
    <div id="sidebar-overlay"></div>
    <aside id="sidebar">
        <!-- Calendar Section -->
        <div class="card neumorphic">
            <h2>Calendario de Progreso</h2>
            <div id="calendar-header">
                <button id="prev-month-btn" class="neumorphic" style="padding: 0.5rem;">&lt;</button>
                <div id="calendar-month-year"></div>
                <button id="next-month-btn" class="neumorphic" style="padding: 0.5rem;">&gt;</button>
            </div>
            <div id="calendar-grid"></div>
            <div id="calendar-tooltip"></div>
        </div>

        <!-- Settings Section moved to sidebar -->
        <details class="card neumorphic collapsible-card" id="settings-section" open>
            <summary>Ajustes</summary>
            <div class="collapsible-content">
                <div class="control-group">
                    <label for="theme-select">Tema</label>
                    <select id="theme-select" class="neumorphic-inset">
                        <option value="light">Claro</option>
                        <option value="dark">Oscuro</option>
                    </select>
                </div>
                 <!-- NUEVO: Interruptor de Notificaciones -->
                <div class="control-group" style="display: flex; justify-content: space-between; align-items: center;">
                    <label for="notifications-toggle" style="margin-bottom: 0;">Notificaciones</label>
                    <label class="switch">
                        <input type="checkbox" id="notifications-toggle">
                        <span class="slider neumorphic-inset"></span>
                    </label>
                </div>
                <div class="control-group">
                    <label for="music-select">MÃºsica de Fondo</label>
                    <select id="music-select" class="neumorphic-inset">
                        <option value="">Ninguna</option>
                        <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3">Lofi Relajante</option>
                        <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3">Piano ClÃ¡sico</option>
                        <option value="custom-music">Personalizada</option>
                    </select>
                    <input type="file" id="custom-music-input" accept="audio/*" style="display: none;">
                    <label for="custom-music-input" id="custom-music-label" class="custom-file-label neumorphic-inset" style="display: none;">Seleccionar archivo de mÃºsica</label>
                </div>
                <div class="control-group">
                    <label for="alarm-sound-select">Sonido de Alarma</label>
                    <select id="alarm-sound-select" class="neumorphic-inset">
                        <option value="default">Default</option>
                        <option value="chime">Chime</option>
                        <option value="signal">Signal</option>
                        <option value="custom-alarm">Personalizado</option>
                    </select>
                    <input type="file" id="custom-alarm-input" accept="audio/*" style="display: none;">
                    <label for="custom-alarm-input" id="custom-alarm-label" class="custom-file-label neumorphic-inset" style="display: none;">Seleccionar archivo de audio</label>
                </div>
                 <h2 style="margin-top: 2rem;">Configurar Tiempos</h2>
                 <div class="control-group">
                    <label for="pomodoro-minutes">Pomodoro</label>
                    <div class="time-input-group">
                       <input type="number" id="pomodoro-minutes" min="0" placeholder="min" class="neumorphic-inset">
                       <input type="number" id="pomodoro-seconds" min="0" max="59" placeholder="sec" class="neumorphic-inset">
                    </div>
                </div>
                <div class="control-group">
                    <label for="short-break-minutes">Descanso Corto</label>
                     <div class="time-input-group">
                       <input type="number" id="short-break-minutes" min="0" placeholder="min" class="neumorphic-inset">
                       <input type="number" id="short-break-seconds" min="0" max="59" placeholder="sec" class="neumorphic-inset">
                    </div>
                </div>
                <div class="control-group">
                    <label for="long-break-minutes">Descanso Largo</label>
                     <div class="time-input-group">
                       <input type="number" id="long-break-minutes" min="0" placeholder="min" class="neumorphic-inset">
                       <input type="number" id="long-break-seconds" min="0" max="59" placeholder="sec" class="neumorphic-inset">
                    </div>
                </div>
                <button id="save-settings-btn" class="btn-primary">Aplicar Tiempos</button>
            </div>
        </details>
        
        <!-- Accessibility Section -->
        <details class="card neumorphic collapsible-card" open>
            <summary>Accesibilidad</summary>
            <div class="collapsible-content">
                <div class="control-group">
                    <label>TamaÃ±o de Letra</label>
                    <div id="font-size-controls" style="display: flex; justify-content: space-around;">
                        <button class="neumorphic" data-size="small" style="padding: 0.5rem 1rem;">A</button>
                        <button class="neumorphic" data-size="medium" style="padding: 0.5rem 1rem;">A</button>
                        <button class="neumorphic" data-size="large" style="padding: 0.5rem 1rem;">A</button>
                    </div>
                </div>
            </div>
        </details>
    </aside>

    <div class="app-container">
        <main class="main-content">
            <!-- Timer Card -->
            <div class="card neumorphic timer-card">
                <div class="neumorphic-inset timer-modes">
                    <button class="mode-button active" data-mode="pomodoro">Pomodoro</button>
                    <button class="mode-button" data-mode="shortBreak">Descanso C.</button>
                    <button class="mode-button" data-mode="longBreak">Descanso L.</button>
                </div>

                <div class="timer-progress-circle neumorphic-inset">
                    <svg>
                        <circle class="progress-ring__circle" stroke="var(--primary-color)" stroke-width="10" fill="transparent" r="130" cx="140" cy="140"/>
                    </svg>
                    <div id="timer" class="timer-display">
                        <span id="timer-text">25:00</span>
                    </div>
                </div>

                <div id="current-task" class="current-task-display">Selecciona una tarea</div>

                <div class="timer-controls">
                    <button id="start-stop-btn" class="control-button neumorphic">
                        <svg class="icon" id="play-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>
                        <svg class="icon" id="pause-icon" style="display:none;" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
                    </button>
                    <button id="reset-btn" class="control-button neumorphic">
                        <svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg>
                    </button>
                </div>
            </div>
        </main>
        
        <aside class="side-content">
            <!-- Tasks Card -->
            <details class="card neumorphic collapsible-card" id="tasks-section" open>
                <summary>Lista de Tareas</summary>
                <div class="collapsible-content">
                    <form id="new-task-form">
                        <input type="text" id="new-task-input" class="neumorphic-inset" placeholder="AÃ±adir una nueva tarea..." required>
                        <button id="add-task-btn" type="submit" class="neumorphic">+</button>
                    </form>
                    <ul id="task-list"></ul>
                </div>
            </details>
            
            <!-- Stats Card -->
             <details class="card neumorphic collapsible-card" id="stats-actions-section" open>
                <summary>Progreso</summary>
                 <div class="collapsible-content">
                    <h2>Tu Progreso</h2>
                     <p>Pomodoros hoy: <span id="pomodoros-today">0</span></p>
                     <p>Pomodoros totales: <span id="pomodoros-total">0</span></p>
                     <p>Tiempo de enfoque hoy: <span id="focus-time-today">0 min</span></p>
                </div>
            </details>
        </aside>
    </div>

    <!-- Modals -->
    <div id="video-modal" class="modal">
        <div class="card neumorphic modal-content">
            <h2>Â¡Hora de un descanso!</h2>
            <p>Un video de ejercicio rÃ¡pido para estirar.</p>
            <div class="video-container" id="video-container"></div>
             <button id="close-video-modal-btn" class="control-button neumorphic" style="margin: 1rem auto 0;">
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
            </button>
        </div>
    </div>

    <div id="day-detail-modal" class="modal">
         <div class="card neumorphic modal-content" style="text-align: left;">
            <h2 id="detail-date"></h2>
            <p><strong>Pomodoros completados:</strong> <span id="detail-pomodoro-count"></span></p>
            <p><strong>Tiempo de enfoque:</strong> <span id="detail-focus-time"></span></p>
            <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem; font-size: 1.1rem;">Tareas del dÃ­a:</h3>
            <ul id="detail-task-list"></ul>
             <button id="close-detail-modal-btn" class="control-button neumorphic" style="margin: 1rem auto 0;">
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
            </button>
        </div>
    </div>

    <div id="notepad-modal" class="modal">
        <div id="notepad-container" class="card neumorphic">
             <div class="notepad-header">
                <button id="close-notepad-btn" class="control-button neumorphic">
                     <svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
                </button>
            </div>
            <textarea id="notepad-textarea" placeholder="Tus notas rÃ¡pidas aquÃ­..."></textarea>
        </div>
    </div>

     <div id="time-edit-modal" class="modal">
        <div class="card neumorphic modal-content" style="max-width: 320px;">
            <h2>Editar Tiempo</h2>
             <div class="control-group">
                <div class="time-input-group">
                   <input type="number" id="edit-minutes-input" min="0" placeholder="min" class="neumorphic-inset">
                   <input type="number" id="edit-seconds-input" min="0" max="59" placeholder="sec" class="neumorphic-inset">
                </div>
            </div>
            <button id="save-time-edit-btn" class="btn-primary">Guardar</button>
        </div>
    </div>


    <audio id="background-music" loop></audio>
    <audio id="notification-sound"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const timerDisplay = document.getElementById('timer');
            const timerText = document.getElementById('timer-text');
            const startStopBtn = document.getElementById('start-stop-btn');
            const resetBtn = document.getElementById('reset-btn');
            const modeButtons = document.querySelectorAll('.mode-button');
            const themeSelect = document.getElementById('theme-select');
            const musicSelect = document.getElementById('music-select');
            const bgMusic = document.getElementById('background-music');
            const notificationSound = document.getElementById('notification-sound');
            const newTaskForm = document.getElementById('new-task-form');
            const newTaskInput = document.getElementById('new-task-input');
            const taskList = document.getElementById('task-list');
            const currentTaskDisplay = document.getElementById('current-task');
            const pomodorosTodayDisplay = document.getElementById('pomodoros-today');
            const pomodorosTotalDisplay = document.getElementById('pomodoros-total');
            const focusTimeTodayDisplay = document.getElementById('focus-time-today');
            const pomodoroMinutesInput = document.getElementById('pomodoro-minutes');
            const pomodoroSecondsInput = document.getElementById('pomodoro-seconds');
            const shortBreakMinutesInput = document.getElementById('short-break-minutes');
            const shortBreakSecondsInput = document.getElementById('short-break-seconds');
            const longBreakMinutesInput = document.getElementById('long-break-minutes');
            const longBreakSecondsInput = document.getElementById('long-break-seconds');
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const progressCircle = document.querySelector('.progress-ring__circle');
            const notepadToggle = document.getElementById('notepad-toggle');
            const notepadModal = document.getElementById('notepad-modal');
            const notepadTextarea = document.getElementById('notepad-textarea');
            const alarmSoundSelect = document.getElementById('alarm-sound-select');
            const customAlarmInput = document.getElementById('custom-alarm-input');
            const customAlarmLabel = document.getElementById('custom-alarm-label');
            const customMusicInput = document.getElementById('custom-music-input');
            const customMusicLabel = document.getElementById('custom-music-label');
            const closeNotepadBtn = document.getElementById('close-notepad-btn');
            const videoModal = document.getElementById('video-modal');
            const videoContainer = document.getElementById('video-container');
            const closeVideoModalBtn = document.getElementById('close-video-modal-btn');
            const dayDetailModal = document.getElementById('day-detail-modal');
            const closeDetailModalBtn = document.getElementById('close-detail-modal-btn');
            const timeEditModal = document.getElementById('time-edit-modal');
            const editMinutesInput = document.getElementById('edit-minutes-input');
            const editSecondsInput = document.getElementById('edit-seconds-input');
            const saveTimeEditBtn = document.getElementById('save-time-edit-btn');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const calendarGrid = document.getElementById('calendar-grid');
            const calendarMonthYear = document.getElementById('calendar-month-year');
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');
            const calendarTooltip = document.getElementById('calendar-tooltip');
            const fontSizeControls = document.getElementById('font-size-controls');
            const notificationsToggle = document.getElementById('notifications-toggle');


            const radius = progressCircle.r.baseVal.value;
            const circumference = 2 * Math.PI * radius;
            
            progressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            progressCircle.style.strokeDashoffset = circumference;

            let state = {
                timerId: null, isRunning: false, currentMode: 'pomodoro', pomodorosCompleted: 0,
                activeTaskId: null,
                time: { pomodoro: 25 * 60, shortBreak: 5 * 60, longBreak: 15 * 60 },
                remainingTime: 25 * 60, tasks: [],
                stats: { total: 0, history: {} },
                notepadContent: '',
                alarmSound: 'default',
                customMusicURL: null,
                customMusicFilename: null,
                fontSize: 'medium',
                notificationsEnabled: true
            };

            let calendarDate = new Date();
            
            const alarmSounds = {
                'default': 'https://www.soundjay.com/buttons/sounds/button-16.mp3',
                'chime': 'https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3',
                'signal': 'https://www.soundjay.com/misc/sounds/signal-goto-sleep-01.mp3',
            };

            const breakVideos = [ 'https://www.youtube.com/embed/s-2T30vYfL0', 'https://www.youtube.com/embed/M-8FvC3f8hA' ];

            function setProgress(percent) {
                const offset = circumference - (percent / 100 * circumference);
                progressCircle.style.strokeDashoffset = offset;
            }
            
            const showNotification = (title, body) => {
                if (!('Notification' in window) || !state.notificationsEnabled) return;
                
                if (Notification.permission === 'granted') {
                    new Notification(title, { body: body, icon: './favicon.ico' });
                } else if (Notification.permission !== 'denied') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            new Notification(title, { body: body, icon: './favicon.ico' });
                        }
                    });
                }
            };

            const updateTimerDisplay = () => {
                const minutes = Math.floor(state.remainingTime / 60);
                const seconds = state.remainingTime % 60;
                timerText.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                document.title = `${timerText.textContent} - Pomodoro Flow`;
                const totalDuration = state.time[state.currentMode];
                const percent = totalDuration > 0 ? ((totalDuration - state.remainingTime) / totalDuration) * 100 : 0;
                setProgress(percent);
            };
            
            const updateStartStopBtn = () => {
                playIcon.style.display = state.isRunning ? 'none' : 'block';
                pauseIcon.style.display = state.isRunning ? 'block' : 'none';
            };
            
            const startTimer = () => {
                if (state.timerId || state.remainingTime < 0) return;
                state.isRunning = true;
                updateStartStopBtn();
                state.timerId = setInterval(() => {
                    state.remainingTime--;
                    if(state.currentMode === 'pomodoro') {
                        const today = getTodayDateString();
                        if(!state.stats.history[today]) {
                            state.stats.history[today] = { count: 0, focusTime: 0, tasks: [] };
                        }
                        state.stats.history[today].focusTime++;
                    }
                    updateTimerDisplay();
                    if (state.remainingTime < 0) {
                        clearInterval(state.timerId);
                        state.timerId = null;
                        state.isRunning = false;
                        handleTimerEnd();
                    }
                }, 1000);
            };

            const stopTimer = () => {
                clearInterval(state.timerId);
                state.timerId = null;
                state.isRunning = false;
                updateStartStopBtn();
            };
            
            const handleTimerEnd = () => {
                let soundSrc = null;
                if (state.alarmSound === 'custom-alarm') {
                    if (notificationSound.src && notificationSound.src.startsWith('data:audio')) {
                        soundSrc = notificationSound.src;
                    }
                } else if (alarmSounds[state.alarmSound]) {
                    soundSrc = alarmSounds[state.alarmSound];
                }

                if (soundSrc) {
                    notificationSound.src = soundSrc;
                    notificationSound.play().catch(e => console.error("Error playing sound:", e));
                }

                let nextMode, notificationTitle, notificationBody;

                if (state.currentMode === 'pomodoro') {
                    state.pomodorosCompleted++;
                    updateStats();
                    nextMode = state.pomodorosCompleted % 4 === 0 ? 'longBreak' : 'shortBreak';
                    notificationTitle = 'Â¡Pomodoro completado!';
                    notificationBody = `Â¡Buen trabajo! Ahora es tiempo de un ${nextMode === 'longBreak' ? 'descanso largo' : 'descanso corto'}.`;
                } else {
                    nextMode = 'pomodoro';
                    notificationTitle = 'Â¡Descanso terminado!';
                    notificationBody = 'Es hora de volver a concentrarse. Â¡Puedes hacerlo!';
                }
                
                showNotification(notificationTitle, notificationBody);
                
                switchMode(nextMode);
                startTimer(); 
            };
            
            const switchMode = (mode) => {
                stopTimer();
                state.currentMode = mode;
                state.remainingTime = state.time[mode];
                updateTimerDisplay();
                modeButtons.forEach(button => button.classList.toggle('active', button.dataset.mode === mode));
                if (mode.includes('Break')) { showBreakContent(); }
            };
            
            const showBreakContent = () => {
                const randomVideo = breakVideos[Math.floor(Math.random() * breakVideos.length)];
                videoContainer.innerHTML = `<iframe src="${randomVideo}" frameborder="0" allowfullscreen></iframe>`;
                videoModal.classList.add('visible');
            };
            
            const hideBreakContent = () => {
                videoModal.classList.remove('visible');
                setTimeout(() => { videoContainer.innerHTML = ''; }, 500); // Wait for transition
            };

            const resetTimer = () => {
                stopTimer();
                state.remainingTime = state.time[state.currentMode];
                updateTimerDisplay();
            };

            const renderTasks = () => {
                taskList.innerHTML = '';
                state.tasks.forEach(task => {
                    const li = document.createElement('li');
                    li.className = task.id === state.activeTaskId ? 'active' : '';
                    const taskNameSpan = document.createElement('span');
                    taskNameSpan.className = 'task-name';
                    taskNameSpan.textContent = task.name;
                    taskNameSpan.onclick = () => setActiveTask(task.id);
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-task';
                    deleteBtn.innerHTML = '&times;';
                    deleteBtn.onclick = () => deleteTask(task.id);
                    li.append(taskNameSpan, deleteBtn);
                    taskList.appendChild(li);
                });
                updateCurrentTaskDisplay();
            };
            
            const addTask = (name) => {
                state.tasks.push({ id: Date.now().toString(), name: name, completed: false });
                renderTasks();
                saveState();
            };

            const deleteTask = (id) => {
                state.tasks = state.tasks.filter(task => task.id !== id);
                if (state.activeTaskId === id) { state.activeTaskId = null; }
                renderTasks();
                saveState();
            };

            const setActiveTask = (id) => {
                state.activeTaskId = id;
                renderTasks();
                saveState();
            };
            
            const updateCurrentTaskDisplay = () => {
                const activeTask = state.tasks.find(t => t.id === state.activeTaskId);
                currentTaskDisplay.textContent = activeTask ? activeTask.name : 'Selecciona una tarea';
            };

            const changeTheme = (theme) => {
                document.documentElement.setAttribute('data-theme', theme);
                saveState();
            };
            
             const setFontSize = (size) => {
                const html = document.documentElement;
                html.classList.remove('font-size-small', 'font-size-large');
                if (size === 'small' || size === 'large') {
                    html.classList.add(`font-size-${size}`);
                }
                state.fontSize = size;
                saveState();
            };

            const playMusic = () => {
                const selectedMusic = musicSelect.value;
                if(selectedMusic === 'custom-music') {
                    if (state.customMusicURL) {
                        bgMusic.src = state.customMusicURL;
                        bgMusic.play().catch(console.error);
                    } else {
                        bgMusic.pause();
                    }
                } else if (selectedMusic) {
                    bgMusic.src = selectedMusic;
                    bgMusic.play().catch(console.error);
                } else {
                    bgMusic.pause();
                }
            };
            
            const updateTimerFromInputs = () => {
                const pMins = parseInt(pomodoroMinutesInput.value) || 0;
                const pSecs = parseInt(pomodoroSecondsInput.value) || 0;
                const sbMins = parseInt(shortBreakMinutesInput.value) || 0;
                const sbSecs = parseInt(shortBreakSecondsInput.value) || 0;
                const lbMins = parseInt(longBreakMinutesInput.value) || 0;
                const lbSecs = parseInt(longBreakSecondsInput.value) || 0;

                state.time.pomodoro = (pMins * 60) + pSecs;
                state.time.shortBreak = (sbMins * 60) + sbSecs;
                state.time.longBreak = (lbMins * 60) + lbSecs;

                saveState();
                if (!state.isRunning) {
                    resetTimer();
                }
                saveSettingsBtn.textContent = 'Â¡Guardado!';
                setTimeout(() => { saveSettingsBtn.textContent = 'Aplicar Tiempos'; }, 1500);
            };
            
            const setTimerInputs = () => {
                pomodoroMinutesInput.value = Math.floor(state.time.pomodoro / 60);
                pomodoroSecondsInput.value = state.time.pomodoro % 60;
                shortBreakMinutesInput.value = Math.floor(state.time.shortBreak / 60);
                shortBreakSecondsInput.value = state.time.shortBreak % 60;
                longBreakMinutesInput.value = Math.floor(state.time.longBreak / 60);
                longBreakSecondsInput.value = state.time.longBreak % 60;
            };

            const getTodayDateString = () => {
                 const today = new Date();
                 const year = today.getFullYear();
                 const month = String(today.getMonth() + 1).padStart(2, '0');
                 const day = String(today.getDate()).padStart(2, '0');
                 return `${year}-${month}-${day}`;
            }

            const updateStats = () => {
                const today = getTodayDateString();
                if(!state.stats.history[today]) {
                    state.stats.history[today] = { count: 0, focusTime: 0, tasks: [] };
                }
                state.stats.history[today].count++;
                
                const activeTask = state.tasks.find(t => t.id === state.activeTaskId);
                if(activeTask){
                    const taskInHistory = state.stats.history[today].tasks.find(t => t.name === activeTask.name);
                    if(!taskInHistory){
                        state.stats.history[today].tasks.push({ name: activeTask.name, completed: true });
                    }
                }

                state.stats.total++;
                renderStats();
                generateCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
                saveState();
            };

            const renderStats = () => {
                const todayData = state.stats.history[getTodayDateString()] || { count: 0, focusTime: 0 };
                pomodorosTodayDisplay.textContent = todayData.count;
                pomodorosTotalDisplay.textContent = state.stats.total;
                focusTimeTodayDisplay.textContent = `${Math.floor(todayData.focusTime / 60)} min`;
            };

            const saveState = () => {
                const stateToSave = { ...state };
                delete stateToSave.timerId;
                delete stateToSave.isRunning;
                delete stateToSave.customMusicURL;
                stateToSave.theme = themeSelect.value;
                stateToSave.music = musicSelect.value;
                localStorage.setItem('pomodoroAppState', JSON.stringify(stateToSave));
            };
            
            const addDemoData = () => {
                const demoData = {
                    "2025-09-18": { count: 4, focusTime: 6000, tasks: [{ name: 'Preparar presentaciÃ³n', completed: true }, { name: 'Revisar emails', completed: true }] },
                    "2025-09-22": { count: 6, focusTime: 9000, tasks: [{ name: 'Informe de anÃ¡lisis', completed: true }, { name: 'Llamada con cliente', completed: true }, { name: 'PlanificaciÃ³n Sprint', completed: false }] },
                    "2025-10-01": { count: 5, focusTime: 7500, tasks: [{ name: 'Desarrollo nueva feature', completed: true }, { name: 'ReuniÃ³n de equipo', completed: true }] },
                    "2025-10-07": { count: 3, focusTime: 4500, tasks: [{ name: 'Bug fixing', completed: true }, { name: 'DocumentaciÃ³n', completed: false }] }
                };
                for(const date in demoData){
                    if(state.stats.history && !state.stats.history[date]){
                        state.stats.history[date] = demoData[date];
                    }
                }
            };

            const loadState = () => {
                const savedState = JSON.parse(localStorage.getItem('pomodoroAppState'));
                if (savedState) {
                    state = { ...state, ...savedState };
                    
                    if (!state.stats) {
                        state.stats = { total: 0, history: {} };
                    }
                    if (!state.stats.history) {
                        state.stats.history = {};
                    }

                    themeSelect.value = state.theme || 'light';
                    musicSelect.value = state.music || '';
                    notepadTextarea.value = state.notepadContent || '';
                    alarmSoundSelect.value = state.alarmSound || 'default';
                    notificationsToggle.checked = state.notificationsEnabled;
                    if (state.music === 'custom-music' && state.customMusicFilename) {
                        customMusicLabel.textContent = `Archivo: ${state.customMusicFilename}`;
                    }
                }
                addDemoData();
            };
            
            const handleAlarmSoundChange = (value) => {
                state.alarmSound = value;
                if (value === 'custom-alarm') {
                    customAlarmLabel.style.display = 'block';
                } else {
                    customAlarmLabel.style.display = 'none';
                    notificationSound.src = alarmSounds[value];
                }
                saveState();
            }
            
            const handleCustomAlarmFile = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    notificationSound.src = e.target.result;
                    customAlarmLabel.textContent = file.name;
                };
                reader.readAsDataURL(file);
            };

            const handleMusicSelectChange = (value) => {
                 if (value === 'custom-music') {
                    customMusicLabel.style.display = 'block';
                } else {
                    customMusicLabel.style.display = 'none';
                }
                playMusic();
                saveState();
            };

            const handleCustomMusicFile = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    state.customMusicURL = e.target.result;
                    state.customMusicFilename = file.name;
                    customMusicLabel.textContent = file.name;
                    playMusic();
                    saveState();
                };
                reader.readAsDataURL(file);
            };

            const showTimerEditor = () => {
                if(state.isRunning) return;

                editMinutesInput.value = Math.floor(state.time[state.currentMode] / 60);
                editSecondsInput.value = state.time[state.currentMode] % 60;
                timeEditModal.classList.add('visible');
            };

            const generateCalendar = (year, month) => {
                calendarGrid.innerHTML = '';
                calendarMonthYear.textContent = `${new Date(year, month).toLocaleString('es-ES', { month: 'long', year: 'numeric' })}`;

                const dayNames = ['D', 'L', 'M', 'X', 'J', 'V', 'S'];
                dayNames.forEach(name => {
                    const dayNameEl = document.createElement('div');
                    dayNameEl.className = 'calendar-day-name';
                    dayNameEl.textContent = name;
                    calendarGrid.appendChild(dayNameEl);
                });

                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();

                for(let i = 0; i < firstDay; i++) {
                    calendarGrid.appendChild(document.createElement('div'));
                }

                for(let day = 1; day <= daysInMonth; day++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day';
                    dayEl.textContent = day;

                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    if(state.stats.history[dateStr]) {
                        dayEl.classList.add('has-data');
                        dayEl.dataset.date = dateStr;
                    }
                    if(day === today.getDate() && year === today.getFullYear() && month === today.getMonth()) {
                        dayEl.classList.add('today');
                    }
                    calendarGrid.appendChild(dayEl);
                }
            };

            const showDayDetails = (dateStr) => {
                const data = state.stats.history[dateStr];
                if(!data) return;

                document.getElementById('detail-date').textContent = new Date(dateStr.replace(/-/g, '/')).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                document.getElementById('detail-pomodoro-count').textContent = data.count;
                document.getElementById('detail-focus-time').textContent = `${Math.floor(data.focusTime / 60)} minutos`;

                const taskListUl = document.getElementById('detail-task-list');
                taskListUl.innerHTML = '';
                if(data.tasks && data.tasks.length > 0) {
                    data.tasks.forEach(task => {
                        const li = document.createElement('li');
                        const icon = task.completed 
                            ? `<svg class="icon" viewBox="0 0 24 24" fill="green"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>`
                            : `<svg class="icon" viewBox="0 0 24 24" fill="orange"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" opacity=".3"/><path d="M12 4c-4.41 0-8 3.59-8 8s3.59 8 8 8 8-3.59 8-8-3.59-8-8-8zm-2 13.5l-5-5 1.41-1.41L10 15.17l7.59-7.59L19 9l-9 9z"/></svg>`;
                        li.innerHTML = `${icon} ${task.name}`;
                        taskListUl.appendChild(li);
                    });
                } else {
                    taskListUl.innerHTML = '<li>No se registraron tareas especÃ­ficas.</li>';
                }

                dayDetailModal.classList.add('visible');
            };
            
            const handleCalendarTooltip = (e) => {
                const target = e.target;
                if(target.classList.contains('has-data')) {
                    const data = state.stats.history[target.dataset.date];
                    calendarTooltip.textContent = `Pomodoros: ${data.count}, Enfoque: ${Math.floor(data.focusTime / 60)} min`;
                    const rect = target.getBoundingClientRect();
                    calendarTooltip.style.left = `${rect.left + rect.width / 2}px`;
                    calendarTooltip.style.top = `${rect.top - 10}px`;
                    calendarTooltip.style.transform = 'translate(-50%, -100%)';
                    calendarTooltip.style.opacity = '1';
                    calendarTooltip.style.visibility = 'visible';
                }
            };

            const hideCalendarTooltip = () => {
                calendarTooltip.style.opacity = '0';
                calendarTooltip.style.visibility = 'hidden';
            };


            // --- Event Listeners ---
            startStopBtn.addEventListener('click', () => { if (state.isRunning) stopTimer(); else startTimer(); });
            resetBtn.addEventListener('click', resetTimer);
            modeButtons.forEach(button => button.addEventListener('click', e => switchMode(e.currentTarget.dataset.mode)));
            themeSelect.addEventListener('change', e => changeTheme(e.target.value));
            
            musicSelect.addEventListener('change', (e) => handleMusicSelectChange(e.target.value));
            customMusicInput.addEventListener('change', (e) => {
                 if (e.target.files.length > 0) {
                    handleCustomMusicFile(e.target.files[0]);
                }
            });

            newTaskForm.addEventListener('submit', e => {
                e.preventDefault();
                const taskName = newTaskInput.value.trim();
                if (taskName) { addTask(taskName); newTaskInput.value = ''; }
            });
            saveSettingsBtn.addEventListener('click', updateTimerFromInputs);
            
            notepadToggle.addEventListener('click', () => notepadModal.classList.add('visible'));
            closeNotepadBtn.addEventListener('click', () => notepadModal.classList.remove('visible'));
            notepadModal.addEventListener('click', (e) => { if (e.target === notepadModal) notepadModal.classList.remove('visible'); });
            notepadTextarea.addEventListener('input', () => {
                state.notepadContent = notepadTextarea.value;
                saveState();
            });

            alarmSoundSelect.addEventListener('change', (e) => handleAlarmSoundChange(e.target.value));
            customAlarmInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleCustomAlarmFile(e.target.files[0]);
                }
            });
            
            notificationsToggle.addEventListener('change', (e) => {
                state.notificationsEnabled = e.target.checked;
                if (e.target.checked && Notification.permission !== 'granted') {
                    Notification.requestPermission();
                }
                saveState();
            });

            closeVideoModalBtn.addEventListener('click', hideBreakContent);
            videoModal.addEventListener('click', (e) => { if(e.target === videoModal) hideBreakContent(); });
            
            closeDetailModalBtn.addEventListener('click', () => dayDetailModal.classList.remove('visible'));
            dayDetailModal.addEventListener('click', (e) => { if(e.target === dayDetailModal) dayDetailModal.classList.remove('visible'); });

            timerDisplay.addEventListener('click', showTimerEditor);
            
            saveTimeEditBtn.addEventListener('click', () => {
                const newMinutes = parseInt(editMinutesInput.value) || 0;
                const newSeconds = parseInt(editSecondsInput.value) || 0;

                state.time[state.currentMode] = (newMinutes * 60) + newSeconds;
                
                saveState();
                setTimerInputs();
                resetTimer();
                timeEditModal.classList.remove('visible');
            });
            timeEditModal.addEventListener('click', (e) => { if(e.target === timeEditModal) timeEditModal.classList.remove('visible'); });

            sidebarToggle.addEventListener('click', () => document.body.classList.add('sidebar-open'));
            sidebarOverlay.addEventListener('click', () => document.body.classList.remove('sidebar-open'));

            prevMonthBtn.addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() - 1);
                generateCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
            });
            nextMonthBtn.addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() + 1);
                generateCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
            });
            
            calendarGrid.addEventListener('mouseover', handleCalendarTooltip);
            calendarGrid.addEventListener('mouseout', hideCalendarTooltip);
            calendarGrid.addEventListener('click', (e) => {
                if (e.target.classList.contains('has-data')) {
                    showDayDetails(e.target.dataset.date);
                }
            });
            
            fontSizeControls.addEventListener('click', (e) => {
                if(e.target.tagName === 'BUTTON') {
                    setFontSize(e.target.dataset.size);
                }
            });


            const init = () => {
                loadState(); 
                setTimerInputs(); 
                renderTasks(); 
                renderStats();
                changeTheme(themeSelect.value);
                setFontSize(state.fontSize);
                handleAlarmSoundChange(alarmSoundSelect.value);
                handleMusicSelectChange(musicSelect.value);
                switchMode(state.currentMode);
                generateCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
                
                if ('Notification' in window && state.notificationsEnabled) {
                    Notification.requestPermission();
                }
            };
            init();
        });
    </script>
</body>
</html>


